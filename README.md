# DaJet Exchange Agent

[Требуется установка .NET Core 3.1](https://dotnet.microsoft.com/download)

Агент DaJet Exchange устанавливается в узле обмена данными
для переноса сообщений из справочника 1С "DaJetExchangeQueue"
в интеграционную систему для обработки и маршрутизации сообщений.

[Подсистема DaJet Exchange для 1С:Предприятие 8](https://github.com/zhichkin/DaJet/tree/master/exchange)

В будущем планируется, что агент DaJet Exchange будет также выполнять
роль загрузчика, предназанченных для узла обмена 1С, сообщений.

**0. Функциональное описание.**

Агент DaJet Exchange для SQL Server и RabbitMQ выполняет экспорт сообщений обмена из справочника 1С **"DaJetExchangeQueue"** в очередь сообщений RabbitMQ.

Для этого необходимо установить исполняемый файл агента **dajet-rabbitmq-producer.exe** на сервере, где находится SQL Server узла обмена 1С. Это условине не обязательно, однако, позволяет избежать лишних сетевых обращений к SQL Server. Для настройки сетевых подключений к SQL Server и RabbitMQ используется файл настроек **appsettings.json**, который должен быть расположен в том же самом каталоге, куда был установлен агент DaJet Exchange.

Кроме сетевых настроек есть настройки, управляющие поведением самого агента. Например, можно указать количество обрабатываемых сообщений в одной транзакции СУБД. Данная настройка **MessagesPerTransaction** позволяет оптимизировать потребление ресурсов СУБД при управлении транзакциями, а также увеличивает производительность экспорта сообщений за единицу времени. Это работает так:
- Открывается транзакция СУБД.
- Читается указанное количество сообщений из SQL Server.
- Сообщения отправляются в RabbitMQ.
- Выбранные сообщения удаляются из SQL Server.
- Выполняется фиксация транзакции СУБД.

Если возникает ошибка, то выполняется откат транзакции СУБД. Это означает, что в худшем случае все отправленные в RabbitMQ сообщения вернутся обратно в очередь на стороне SQL Server и будут повторно отправлены в следующий раз.

Настройка **CriticalErrorDelay** нужна в тех случаях, когда SQL Server или RabbitMQ недоступны. В таком случае агент DaJet Exchange "засыпает" на указанное количество миллисекунд. Другая аналогичная настройка **ReceivingMessagesPeriodicity** указывает интервал "засыпания" агента когда в узле обмена больше нет сообщений.

Настройка **WaitForNotificationTimeout** используется в том случае, если в базе данных SQL Server включён функционал оповещений о появлении новых сообщений в узле обмена. Этот функционал необходим для организации **онлайн обмена сообщениями**.

Работает это так:
- Если в узле обмена больше нет сообщений, агент регистрирует ожидание оповещения на указанное в настройке WaitForNotificationTimeout время на стороне SQL Server.
- Если за время ожидания появляется сообщение в узле обмена, SQL Server незамедлительно уведомляет об этом агента. Агент начинает обработку сообщений.
- Если за время ожидания новых сообщений не появляется, агент уведомляется об этом, на всякий случай проверяет очередь сообщений и снова переходит в режим ожидания.

Если функционал оповещений SQL Server не включён, агент его не использует и загружает сообщения из очереди с интервалом, указанным в настройке **ReceivingMessagesPeriodicity**.

**1. Установка агента для экспорта сообщений из SQL Server в RabbitMQ.**
- Скачать актуальный релиз **dajet-rabbitmq-producer**.
- Распаковать архив в папку на сервере узла обмена 1С, где установлен SQL Server.
- Настроить файл **appsettings.json** (смотри описание файла настроек ниже).

Агент ведёт свой журнал **dajet-rabbitmq-producer.log** в каталоге установки.

**1.1. Установка агента как Windows сервиса**
- Выполнить от имени администратора системы команду:
```SQL
sc create "DaJet Exchange Agent" binPath="D:\dajet-agent\dajet-rabbitmq-producer.exe"
```
В данном случае установочный архив распакован в каталог D:\dajet-agent\.

- Перейти в системную консоль управления сервисами Windows.
- Найти и запустить сервис DaJet Exchange Agent.
- При необходимости заменить пользователя Windows, от имени которого работает сервис.
- При необходимости установить тип запуска Automatic, чтобы сервис стартовал при запуске/перезагрузке системы.

Агент может работать в среде Linux, в том числе как демон Linux.

**2. Описание файла appsettings.json.**

- **LogSize** - размер файла лога, по умолчанию равен 64 Kb, по достижению этого размера пересоздаётся
- **CriticalErrorDelay** - интервал ожидания доступности SQL Server или RabbitMQ в секундах.
- **MessagesPerTransaction** - количество сообщений, обрабатываемых за одну транзакцию СУБД.
- **ReceivingMessagesPeriodicity** - интервал ожидания новых сообщений в узле обмена в секундах.
- **UseNotifications** - использование уведомлений SQL Server Service Broker (по умолчанию = false).
- **WaitForNotificationTimeout** - таймаут ожидания уведомления о новых сообщениях в узле обмена в секундах.

- **ConsumerSettings** - секция настройки подключения к SQL Server.
  - **ServerName** - сетевое имя сервера.
  - **DatabaseName** - имя базы данных, в которой установлена подсистема DaJet Exchange.
  - **UserName** - имя пользователя базы данных СУБД (для Windows аутентификации не указывается).
  - **Password** - пароль пользователя базы данных СУБД.

- **ProducerSettings** - секция настройки подключения к RabbitMQ.
  - **HostName** - сетевой адрес сервера.
  - **VirtualHost** - имя вируального сервера (по умолчанию "/").
  - **PortNumber** - порт сервера.
  - **UserName** - имя пользователя для подключения к серверу.
  - **Password** - пароль пользователя для подключения к серверу.
  - **QueueName** - имя очереди сообщений по умолчанию.
  - **RoutingKey** - ключ маршрутизации сообщения (queue binding key).
  - **ExchangeName** - имя точки обмена типа "topic", дополняется настройкой **MessageTypeRouting**.
  - **ConfirmationTimeout** - таймаут ожидания подтверждения сервером RabbitMQ получения сообщения (publisher confirm).
  - **MessageTypeRouting** - сопоставление типов сообщений 1С и очередей RabbitMQ для точек обмена типа "direct".

Если использовать настройки **ExchangeName** и **MessageTypeRouting** из примера ниже, то необходимо в RabbitMQ создать точки обмена и соответствующие им очереди со следующими именами:
- dajet.goods (Справочник.Номенклатура)
- dajet.orders (Документ.ЗаказКлиента)
- dajet.prices (РегистрСведений.ЦеныНоменклатуры)
- dajet.stocks (РегистрНакопления.ОстаткиТоваров)

Другими словами, настройка сопоставления выполняет замену в имени точки обмена слова "exchange" на указанное слово в настройках для данного типа сообщения. Таким образом наименование точки обмена в настройке **ExchangeName** должно обязательно содержать это заменяемое слово и может иметь следующие варианты:
- dajet.exchange
- exchange.dajet
- consumer.producer.exchange
- и так далее

Если сопоставление типа сообщения имени точки обмена не выполнено, то такое сообщение будет отправляться в точку обмена по умолчанию, которое указано в настройке **ExchangeName**.

**Пример секции ProducerSettings:**
```json
{
  "ProducerSettings": {
    "HostName": "localhost",
    "VirtualHost": "/",
    "PortNumber": 5672,
    "UserName": "guest",
    "Password": "guest",
    "QueueName": "dajet.queue",
    "RoutingKey": "",
    "ExchangeName": "dajet.exchange",
    "ConfirmationTimeout": 10,
    "MessageTypeRouting": {
      "Справочник.Номенклатура": "goods",
      "Документ.ЗаказКлиента": "orders",
      "РегистрСведений.ЦеныНоменклатуры": "prices",
      "РегистрНакопления.ОстаткиТоваров": "stocks"
    }
  }
}
```

- **DaJetExchangeQueue** - секция настройки SQL имён для справочника исходящих сообщений

Имена таблицы и её полей можно получить при помощи обработки 1С DaJetExchange. Кнопка "Получить данные таблицы".

**Пример секции DaJetExchangeQueue:**
```json
{
  "DaJetExchangeQueue": {
    "ObjectName": "РегистрСведений.DaJetExchangeQueue",
    "TableName": "_InfoRg200",
    "Properties": [
      { "Name": "МоментВремени", "Field": "_Fld201" },
      { "Name": "Идентификатор", "Field": "_Fld202" },
      { "Name": "ТипСообщения",  "Field": "_Fld203" },
      { "Name": "ТелоСообщения", "Field": "_Fld204" },
      { "Name": "ДатаВремя",     "Field": "_Fld205" },
      { "Name": "ТипОперации",   "Field": "_Fld206" }
    ]
  }
}
```

**3. Запуск агента DaJet Exchange для SQL Server и RabbitMQ.**
- Запустить исполняемый файл агента **dajet-rabbitmq-producer.exe**.
- Если агент установлен как Windows сервис, то запустить сервис.

**4. Настройка онлайн (событийного) обмена данными.**
- Выполнить SQL-скрипт **setup-service-broker.sql** из каталога **sql** в базе данных узла обмена 1С.
- Выполнить SQL-скрипт **export-queue-trigger.sql** из каталога **sql** в базе данных узла обмена 1С.

Во втором скрипте необходимо заменить название целевой таблицы на актуальное. Актуальное название таблицы SQL Server для справочника исходящих сообщений **"DaJetExchangeQueue"** можно получить при помощи функции 1С "ПолучитьСтруктуруХраненияБазыДанных".

```C#
Функция ПолучитьНазваниеТаблицыСУБД()
	
	СтруктураДанных = Новый Структура();
	
	Отбор = Новый Массив();
	Отбор.Добавить(Метаданные.РегистрыСведений.DaJetExchangeQueue);
	ОписаниеДанных = ПолучитьСтруктуруХраненияБазыДанных(Отбор, Истина);
	
	ОписаниеТаблицы = ОписаниеДанных.Найти("Основная", "Назначение");
	Если ОписаниеТаблицы = Неопределено Тогда
		Возврат "Описание основной таблицы не найдено.";
	КонецЕсли;
	
	СтруктураДанных.Вставить("ObjectName", ОписаниеТаблицы.Метаданные);
	СтруктураДанных.Вставить("TableName", ОписаниеТаблицы.ИмяТаблицыХранения);
	СтруктураДанных.Вставить("Properties", Новый Массив());
	
	Для Каждого Поле Из ОписаниеТаблицы.Поля Цикл
		СтруктураПоля = Новый Структура();
		СтруктураПоля.Вставить("Name", Поле.ИмяПоля);
		СтруктураПоля.Вставить("Field", Поле.ИмяПоляХранения);
		СтруктураДанных.Properties.Добавить(СтруктураПоля);
	КонецЦикла;
	
	ЗаписьJSON = Новый ЗаписьJSON();
	ЗаписьJSON.УстановитьСтроку();
	ЗаписатьJSON(ЗаписьJSON, СтруктураДанных);
	
	Возврат ЗаписьJSON.Закрыть();
	
КонецФункции
```
